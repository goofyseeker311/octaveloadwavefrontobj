function [k,d,u,r] = cubemapplanes(vpos,vres,vrot)
  global cmpl;
  if (isempty(cmpl)||(size(cmpl{1,2},1)!=vres))
    [anglelist,steplist] = cubemapangles(vres);
    fwdvectors = [ones(vres,1) zeros(vres,1) steplist'];
    fwdvectors = fwdvectors./vectorlength(fwdvectors);
    cubemaprgt = (ones(vres,1)*[0 -1 0]);
    cubemapup = cross(cubemaprgt',fwdvectors')';
    cubemapup = cubemapup./vectorlength(cubemapup);
    cmupx = (rotationmatrix(0,0,180)*cubemapup')';
    cmupx90 = (rotationmatrix(90,0,0)*cmupx')';
    cmupz90a = (rotationmatrix(0,0,90)*cmupx')';
    cmupz90b = (rotationmatrix(0,0,90)*cmupx90')';
    cmupz180a = (rotationmatrix(0,0,180)*cmupx')';
    cmupz180b = (rotationmatrix(0,0,180)*cmupx90')';
    cmupz270a = (rotationmatrix(0,0,270)*cmupx')';
    cmupz270b = (rotationmatrix(0,0,270)*cmupx90')';
    cmupy90a = (rotationmatrix(0,90,0)*cmupx')';
    cmupy90b = (rotationmatrix(0,90,0)*cmupx90')';
    cmupy270a = (rotationmatrix(0,270,0)*cmupx')';
    cmupy270b = (rotationmatrix(0,270,0)*cmupx90')';
    cmpl = {cmupx cmupx90; cmupz90a cmupz90b; cmupz180a cmupz180b; cmupz270a cmupz270b; cmupy90a cmupy90b; cmupy270a cmupy270b};
  endif
  cmrotmat=rotationmatrix(vrot(1),vrot(2),vrot(3)); cmplrot = cmpl;
  for n = 1:6; cmplrot{n,1}=(cmrotmat*(cmplrot{n,1}'))'; cmplrot{n,2}=(cmrotmat*(cmplrot{n,2}'))'; endfor
  rotx = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{1,1});
  rotx90p = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{1,2});
  rotz90ap = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{2,1});
  rotz90bp = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{2,2});
  rotz180ap = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{3,1});
  rotz180bp = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{3,2});
  rotz270ap = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{4,1});
  rotz270bp = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{4,2});
  roty90ap = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{5,1});
  roty90bp = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{5,2});
  roty270ap = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{6,1});
  roty270bp = planefromnormalatpoint(ones(vres,1)*vpos,cmplrot{6,2});
  k = {rotx rotx90p; rotz90ap rotz90bp; rotz180ap rotz180bp; rotz270ap rotz270bp; roty90ap roty90bp; roty270ap roty270bp};
  dp11 = planefromnormalatpoint(vpos,normalizevector(cmplrot{1,1}(end,:)-cmplrot{1,1}(1,:)));
  dp12 = planefromnormalatpoint(vpos,normalizevector(cmplrot{1,2}(end,:)-cmplrot{1,2}(1,:)));
  dp21 = planefromnormalatpoint(vpos,normalizevector(cmplrot{2,1}(end,:)-cmplrot{2,1}(1,:)));
  dp22 = planefromnormalatpoint(vpos,normalizevector(cmplrot{2,2}(end,:)-cmplrot{2,2}(1,:)));
  dp31 = planefromnormalatpoint(vpos,normalizevector(cmplrot{3,1}(end,:)-cmplrot{3,1}(1,:)));
  dp32 = planefromnormalatpoint(vpos,normalizevector(cmplrot{3,2}(end,:)-cmplrot{3,2}(1,:)));
  dp41 = planefromnormalatpoint(vpos,normalizevector(cmplrot{4,1}(end,:)-cmplrot{4,1}(1,:)));
  dp42 = planefromnormalatpoint(vpos,normalizevector(cmplrot{4,2}(end,:)-cmplrot{4,2}(1,:)));
  dp51 = planefromnormalatpoint(vpos,normalizevector(cmplrot{5,1}(end,:)-cmplrot{5,1}(1,:)));
  dp52 = planefromnormalatpoint(vpos,normalizevector(cmplrot{5,2}(end,:)-cmplrot{5,2}(1,:)));
  dp61 = planefromnormalatpoint(vpos,normalizevector(cmplrot{6,1}(end,:)-cmplrot{6,1}(1,:)));
  dp62 = planefromnormalatpoint(vpos,normalizevector(cmplrot{6,2}(end,:)-cmplrot{6,2}(1,:)));
  d = {dp11 dp12;dp21 dp22;dp31 dp32;dp41 dp42;dp51 dp52;dp61 dp62};
  up11 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{1,1}(end,:),cmplrot{1,1}(1,:))));
  up12 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{1,2}(end,:),cmplrot{1,2}(1,:))));
  up21 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{2,1}(end,:),cmplrot{2,1}(1,:))));
  up22 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{2,2}(end,:),cmplrot{2,2}(1,:))));
  up31 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{3,1}(end,:),cmplrot{3,1}(1,:))));
  up32 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{3,2}(end,:),cmplrot{3,2}(1,:))));
  up41 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{4,1}(end,:),cmplrot{4,1}(1,:))));
  up42 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{4,2}(end,:),cmplrot{4,2}(1,:))));
  up51 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{5,1}(end,:),cmplrot{5,1}(1,:))));
  up52 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{5,2}(end,:),cmplrot{5,2}(1,:))));
  up61 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{6,1}(end,:),cmplrot{6,1}(1,:))));
  up62 = planefromnormalatpoint(vpos,normalizevector(cross(cmplrot{6,2}(end,:),cmplrot{6,2}(1,:))));
  u = {up11 up12;up21 up22;up31 up32;up41 up42;up51 up52;up61 up62;};
  rp11 = planefromnormalatpoint(vpos,normalizevector(cross(dp11(1:3),up11(1:3))));
  rp12 = planefromnormalatpoint(vpos,normalizevector(cross(dp12(1:3),up12(1:3))));
  rp21 = planefromnormalatpoint(vpos,normalizevector(cross(dp21(1:3),up21(1:3))));
  rp22 = planefromnormalatpoint(vpos,normalizevector(cross(dp22(1:3),up22(1:3))));
  rp31 = planefromnormalatpoint(vpos,normalizevector(cross(dp31(1:3),up31(1:3))));
  rp32 = planefromnormalatpoint(vpos,normalizevector(cross(dp32(1:3),up32(1:3))));
  rp41 = planefromnormalatpoint(vpos,normalizevector(cross(dp41(1:3),up41(1:3))));
  rp42 = planefromnormalatpoint(vpos,normalizevector(cross(dp42(1:3),up42(1:3))));
  rp51 = planefromnormalatpoint(vpos,normalizevector(cross(dp51(1:3),up51(1:3))));
  rp52 = planefromnormalatpoint(vpos,normalizevector(cross(dp52(1:3),up52(1:3))));
  rp61 = planefromnormalatpoint(vpos,normalizevector(cross(dp61(1:3),up61(1:3))));
  rp62 = planefromnormalatpoint(vpos,normalizevector(cross(dp62(1:3),up62(1:3))));
  r = {rp11 rp12;rp21 rp22;rp31 rp32;rp41 rp42;rp51 rp52;rp61 rp62};
endfunction
